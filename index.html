<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " vocab="http://ogp.me/ns" lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="A place for me to talk about whatever comes to mind.">
<meta name="viewport" content="width=device-width">
<title>Evan's Ramblings | Evan's Ramblings</title>
<link href="assets/css/all.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">
<link rel="alternate" type="application/rss+xml" title="RSS" href="rss.xml">
<link rel="canonical" href="http://fos.tech/">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]--><link rel="prefetch" href="posts/wccp-redundancy-and-clustering-of-caches-and-wan-optimizers/" type="text/html">
</head>
<body>
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
            styles, `#sidebar-checkbox` for behavior. -->
    <input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox"><!-- Toggleable sidebar --><div class="sidebar" id="sidebar">
        <div class="sidebar-item">
            <p>A reserved <a href="https://getnikola.com" target="_blank">Nikola</a> theme that places the utmost gravity on content with a hidden drawer. Made by <a href="https://twitter.com/mdo" target="_blank">@mdo</a> for Jekyll,
            ported to Nikola by <a href="https://twitter.com/ralsina" target="_blank">@ralsina</a>.</p>
        </div>
        
    <nav id="menu" role="navigation" class="sidebar-nav"><a class="sidebar-nav-item" href="archive.html">Archive</a>
        <a class="sidebar-nav-item" href="categories/index.html">Tags</a>
        <a class="sidebar-nav-item" href="rss.xml">RSS feed</a>
        <a class="sidebar-nav-item" href="resume.pdf">Resume</a>
    
    
    </nav>
</div>

    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          
    <h3 id="brand" class="masthead-title">
      <a href="http://fos.tech/" title="Evan's Ramblings" rel="home">Evan's Ramblings</a>
    </h3>

        </div>
      </div>

      <div class="container content" id="content">
        

<div class="posts">
    <article class="post h-entry post-text"><header><h1 class="post-title p-name"><a href="posts/wccp-redundancy-and-clustering-of-caches-and-wan-optimizers/" class="u-url">WCCP - Redundancy and clustering of caches and WAN optimizers</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">Evan Foster</span></p>
            <p class="dateline"><a href="posts/wccp-redundancy-and-clustering-of-caches-and-wan-optimizers/" rel="bookmark"><time class="post-date published dt-published" datetime="2016-11-10T18:55:43-07:00" title="2016-11-10 18:55">2016-11-10 18:55</time></a></p>
                <p class="commentline">
        
    <a href="posts/wccp-redundancy-and-clustering-of-caches-and-wan-optimizers/#disqus_thread" data-disqus-identifier="cache/posts/wccp-redundancy-and-clustering-of-caches-and-wan-optimizers.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<h3>What is WCCP?</h3>
<p><a href="http://www.cisco.com/c/en/us/td/docs/ios-xml/ios/ipapp/configuration/12-4t/iap-12-4t-book/iap-wccp.html">WCCP</a> is a service offered on Cisco routers and switches that makes it simple to deploy web caches and WAN optimizers among other things. It offers a lot of functionality including failover, redundancy and clustering, and complete control of ports while requiring minimal configuration changes on the switch or router; almost all of the config is done on the cache or WAN optimizer, allowing your vendor to do what they do best. This power and configuration simplicity comes at the cost of a few pretty serious caveats. I'll get onto those, but first I need to explain how traffic flows. For those who already know WCCP, I'm going to be focusing on L2/Mask inbound redirection, so if you need guidance on GRE/Hash and/or outbound redirection, you'll want to look elsewhere. Also, this post is going to focus soley on caches. WAN optimizers have some trickery that I don't feel like covering right now, but there are some good guides out there on how to deploy those. Finally, I don't really want to cover how web caching works. I'll save that for another article.</p>
<h3>How WCCP works (roughly)</h3>
<p>Check out this diagram:</p>
<p><img alt="WCCP flow diagram" src="images/wccp-flow.png"></p>
<p>This is how I explain the flow of WCCP to customers. The client makes a request (1), the router redirects that request to the cache (2), the cache goes and fetches the request from the webserver via the router (3 + 4), the webserver responds to the cache (5 + 6), and finally the cache sends the response to the client (7 + 8). It's important for the traffic to flow in this "sideways T" configuration. If you don't do it this way, <em>things will break</em>. Next, a quick config primer.</p>
<h3>WCCP config on the router or switch</h3>
<p>The configuration for WCCP is stupid simple on the router. Let's say that in the example above, there are three VLANs. VLAN 10 is for the clients, VLAN 20 is for the cache, and VLAN 30 is for the internet. Next, let's say that we want to redirect port 80 TCP traffic (HTTP). WCCP uses service groups to allow you to redirect several ports at once. These can range from 0 to 100, but 0 is a special, static group that only redirects destination port 80 TCP traffic. On a router, it can also be written as <code>web-cache</code>. In this example, we'll use the <code>web-cache</code> service group. Here's what the config would look like on the router:</p>
<pre class="code literal-block"><span></span>ip wccp web-cache
interface vlan 10
    ip wccp web-cache redirect in
</pre>


<p>Seems too good to be true, right? Well, yes and no. That really <em>is</em> everything that's needed on the router. You'll need to configure your cache however. The cache needs to inform the router that it exists and that the router should send traffic to it. The cache needs to be set up with the same service group, and it needs to have the port you want to redirect. If you're using the <code>web-cache</code> service group then it <strong>must be TCP dest 80.</strong> I'm not going to show you this part because the configuration for a Superlumin cache vs. a Bluecoat vs. Cisco stuff is completely different.</p>
<p>So, with that said here's what's happening.  WCCP will watch all packets coming <strong>in</strong> on VLAN 10. When it sees a packet that matches what the cache has told it to send over (in this case, port 80), it punts it over to the cache server at which point regular routing takes over. There are a couple different ways the traffic can get sent over to the cache, but in most cases just pick L2 redirect. It's the simplest and lowest overhead option. This is also configured on the cache. Now, onto the caveats!</p>
<h3>Caveat Emptor</h3>
<ol>
<li>
<p>Circular redirection<br>
 This is a really easy trap to fall into. WCCP is stupid. Like, really, really stupid. If you tell it to redirect TCP port 80 traffic then by god it's going to do it. This means that if the cache is behind the interface that's redirecting traffic (VLAN 10 in our above example) then when the cache goes to make a request out to the internet, the router will send it back to the cache, and it will cycle on and on. There are two solutions to this problem.  </p>
<ol>
<li>Have a separate VLAN for the cache and the clients</li>
<li>Configure WCCP with an ACL that prohibits redirecting traffic from the cache</li>
</ol>
<p>If I had my way, I would always, <strong>always</strong> do option 1. it's cleaner and will always work, regardless of what router or switch you have. If you have to take the second route then it's imperative that you check the docs for your router or switch, because the ACL can have different requirements. Really though, just use option 1. Please.</p>
</li>
<li>
<p>Layer 2 Adjacency<br>
When using L2 redirection, it's important that the cache be layer 2 adjacent to the router. When I first learned this my brain immediately thought <em>what the hell does that mean?</em> To put it simply, no routing can happen between the cache and the router. The cache could be hooked up to the router by twenty switches and it will work fine, but if any routing has to occur then L2 adjacency is broken and no redirection will happen. You can typically see this by running <code>show ip wccp &lt;service-group&gt; detail</code>, although this isn't the same across all routers and switches.  </p>
</li>
<li>
<p>Routers gotta route, yo<br>
WCCP doesn't operate on switched traffic. What do I mean by that? Basically, if traffic is flowing through your router or switch without being routed to that router or switch then it's not going to redirect. WCCP is not transparent in this regard, as compared to a Linux bridge sitting in the flow of traffic. <strong>In addition</strong>, the clientside and internet facing side of the router or switch <strong>must be different subnets.</strong> That device needs to <strong>route.</strong></p>
</li>
</ol>
<h3>Final thoughts</h3>
<p>WCCP is awesome and complicated. This post doesn't touch on a lot of the finer details of the protocol. If you're going to be working with WCCP on a regular basis, I'd recommend reading through the Cisco doc I linked at the beginning of the post.</p>
</div>
    </div>
    </article><article class="post h-entry post-text"><header><h1 class="post-title p-name"><a href="posts/pyroute2-linux-networking-made-easy/" class="u-url">pyroute2 - Linux networking made easy</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">Evan Foster</span></p>
            <p class="dateline"><a href="posts/pyroute2-linux-networking-made-easy/" rel="bookmark"><time class="post-date published dt-published" datetime="2016-11-05T16:05:17-06:00" title="2016-11-05 16:05">2016-11-05 16:05</time></a></p>
                <p class="commentline">
        
    <a href="posts/pyroute2-linux-networking-made-easy/#disqus_thread" data-disqus-identifier="cache/posts/pyroute2-linux-networking-made-easy.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<h3>What is pyroute2?</h3>
<p><a href="https://github.com/svinota/pyroute2">pyroute2</a> is a Python library that uses <a href="https://en.wikipedia.org/wiki/Netlink">Netlink sockets</a> to interact with the Linux networking stack. It is, in my opinion, the single best way to do anything networking related on Linux machines. Beyond simple things like replacing subprocess calls to <code>ifconfig</code> to get and change networking information, it offers a fantastic way to monitor networking related changes (interfaces up and down, new neighbors) and perform actions based upon those. I'll show you how to do that in this post. First, you need to understand some things about Netlink.</p>
<h3>Netlink basics</h3>
<p>Netlink is super cool. With it, you can register a program to receive all Netlink messages, no polling required. There are quite a few different messages that Netlink can generate. I like to represent those as an enum in Python:</p>
<pre class="code literal-block"><span></span><span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="k">class</span> <span class="nc">NetlinkEvents</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="c1"># A new neighbor has appeared</span>
    <span class="n">RTM_NEWNEIGH</span> <span class="o">=</span> <span class="s1">'RTM_NEWNEIGH'</span>
    <span class="c1"># We're no longer watching a certain neighbor</span>
    <span class="n">RTM_DELNEIGH</span> <span class="o">=</span> <span class="s1">'RTM_DELNEIGH'</span>
    <span class="c1"># A new network interface has been created</span>
    <span class="n">RTM_NEWLINK</span> <span class="o">=</span> <span class="s1">'RTM_NEWLINK'</span>
    <span class="c1"># A network interface has been deleted</span>
    <span class="n">RTM_DELLINK</span> <span class="o">=</span> <span class="s1">'RTM_DELLINK'</span>
    <span class="c1"># An IP address has been added to a network interface</span>
    <span class="n">RTM_NEWADDR</span> <span class="o">=</span> <span class="s1">'RTM_NEWADDR'</span>
    <span class="c1"># An IP address has been deleted off of a network interface</span>
    <span class="n">RTM_DELADDR</span> <span class="o">=</span> <span class="s1">'RTM_DELADDR'</span>
    <span class="c1"># A route has been added to the routing table</span>
    <span class="n">RTM_NEWROUTE</span> <span class="o">=</span> <span class="s1">'RTM_NEWROUTE'</span>
    <span class="c1"># A route has been removed from the routing table</span>
    <span class="n">RTM_DELROUTE</span> <span class="o">=</span> <span class="s1">'RTM_DELROUTE'</span>
</pre>


<p>This is not an all inclusive list of possible messages. If you want that, <a href="http://man7.org/linux/man-pages/man7/rtnetlink.7.html">this is a good place to start.</a></p>
<p>Now that we have some Netlink events defined, let's put them to use by watching for new addresses. This is where we'll use pyroute2.</p>
<h3>pyroute2 callbacks</h3>
<p>First things first, let's import what we need from pyroute2. There are a couple of different ways to use pyroute2, but here I'm going to use IPDB.</p>
<pre class="code literal-block"><span></span><span class="kn">from</span> <span class="nn">pyroute2</span> <span class="kn">import</span> <span class="n">IPDB</span>
<span class="n">ipdb</span> <span class="o">=</span> <span class="n">IPDB</span><span class="p">()</span>
<span class="c1"># We'll use this later</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="n">pp</span> <span class="o">=</span> <span class="n">pprint</span><span class="o">.</span><span class="n">PrettyPrinter</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre>


<p>Next, we'll make our callback. This callback needs to have 3 arguments:</p>
<pre class="code literal-block"><span></span><span class="k">def</span> <span class="nf">new_address_callback</span><span class="p">(</span><span class="n">ipdb</span><span class="p">,</span> <span class="n">netlink_message</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="n">NetlinkMessages</span><span class="o">.</span><span class="n">RTM_NEWADDR</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
        <span class="n">pp</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">netlink_message</span><span class="p">)</span>
</pre>


<p>The first two arguments are fairly obvious, but the third one is a bit vague. action is basically the type of message, so we can use this to filter out the stuff we don't care about. Now, we'll fire things up!</p>
<pre class="code literal-block"><span></span><span class="n">addr_callback</span> <span class="o">=</span> <span class="n">ipdb</span><span class="o">.</span><span class="n">register_callback</span><span class="p">(</span><span class="n">new_address_callback</span><span class="p">)</span>
</pre>


<p><code>register_callback</code> returns the ID of the callback which you'll need to cleanly stop it, so make sure you capture that! To test, we'll pop on over to a shell and add an address to <code>eth0</code>.</p>
<pre class="code literal-block"><span></span><span class="o">[</span>evan@goliath ~<span class="o">]</span>$ sudo ip addr add dev eth0 192.168.2.50/24
</pre>


<p>Back in Python, we should now see something like this:</p>
<pre class="code literal-block"><span></span><span class="p">{</span>  <span class="s1">'attrs'</span><span class="p">:</span> <span class="p">[</span>  <span class="p">(</span><span class="s1">'IFA_ADDRESS'</span><span class="p">,</span> <span class="s1">'192.168.2.50'</span><span class="p">),</span>
               <span class="p">(</span><span class="s1">'IFA_LOCAL'</span><span class="p">,</span> <span class="s1">'192.168.2.50'</span><span class="p">),</span>
               <span class="p">(</span><span class="s1">'IFA_LABEL'</span><span class="p">,</span> <span class="s1">'eth0'</span><span class="p">),</span>
               <span class="p">(</span><span class="s1">'IFA_FLAGS'</span><span class="p">,</span> <span class="mi">129</span><span class="p">),</span>
               <span class="p">(</span><span class="s1">'IFA_CACHEINFO'</span><span class="p">,</span> <span class="p">{</span><span class="s1">'ifa_valid'</span><span class="p">:</span> <span class="mi">4294967295</span><span class="p">,</span> <span class="s1">'ifa_prefered'</span><span class="p">:</span> <span class="mi">4294967295</span><span class="p">,</span> <span class="s1">'tstamp'</span><span class="p">:</span> <span class="mi">3663995</span><span class="p">,</span> <span class="s1">'cstamp'</span><span class="p">:</span> <span class="mi">3663995</span><span class="p">})],</span>
   <span class="s1">'event'</span><span class="p">:</span> <span class="s1">'RTM_NEWADDR'</span><span class="p">,</span>
   <span class="s1">'family'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
   <span class="s1">'flags'</span><span class="p">:</span> <span class="mi">129</span><span class="p">,</span>
   <span class="s1">'header'</span><span class="p">:</span> <span class="p">{</span>  <span class="s1">'error'</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                <span class="s1">'flags'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">'length'</span><span class="p">:</span> <span class="mi">84</span><span class="p">,</span>
                <span class="s1">'pid'</span><span class="p">:</span> <span class="mi">27963</span><span class="p">,</span>
                <span class="s1">'sequence_number'</span><span class="p">:</span> <span class="mi">1478380920</span><span class="p">,</span>
                <span class="s1">'type'</span><span class="p">:</span> <span class="mi">20</span><span class="p">},</span>
   <span class="s1">'index'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
   <span class="s1">'prefixlen'</span><span class="p">:</span> <span class="mi">24</span><span class="p">,</span>
   <span class="s1">'scope'</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
</pre>


<p>Once you're finished, you can stop the callback as such:</p>
<pre class="code literal-block"><span></span><span class="n">ipdb</span><span class="o">.</span><span class="n">unregister_callback</span><span class="p">(</span><span class="n">addr_callback</span><span class="p">)</span>
</pre>


<p>Nice and simple, right?</p>
<h3>Final notes</h3>
<p>I've used pyroute2 both professionally and personally and have found it to be a necessity when dealing with any sort of Linux networking. I've barely scratched the surface of what it can do; <a href="http://docs.pyroute2.org/general.html">check out the docs if you want to see how powerful it is.</a> It's a really great library and I wish it was used more widely.</p>
<p>If you find any mistakes in this post, please let me know about them by emailing me at the address in the footer. I've simplified things quite a bit here to make this post easier to digest, so if I've cut out something important I'd like to fix it.</p>
</div>
    </div>
    </article>
</div>



        
       <script>var disqus_shortname="evansramblings";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script><footer id="footer"><p>Contents © 2016         <a href="mailto:evan@fos.tech">Evan Foster</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         </p>
            
        </footer>
</div>
    </div>
    <label for="sidebar-checkbox" class="sidebar-toggle"></label>
    
    
    
            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates -->
</body>
</html>
